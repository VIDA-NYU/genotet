$(document).ready(function(){genotet.init()});
var genotet={init:function(){genotet.data.init();genotet.panelManager.init();genotet.viewManager.init();genotet.menu.init();genotet.options.init();genotet.tooltip.init();genotet.test&&genotet.test.run()},warning:function(){var a=Array.prototype.slice.call(arguments).join(" ");console.warn(a);genotet.options.allowMessage&&$("#warning").text(a).parent().slideDown()},error:function(){var a=Array.prototype.slice.call(arguments).join(" ");console.error(a);genotet.options.allowMessage&&$("#error").text(a).parent().slideDown()},
success:function(){var a=Array.prototype.slice.call(arguments).join(" ");console.info(a);genotet.options.allowMessage&&$("#success").text(a).parent().slideDown()}};genotet.utils={};genotet.utils.keyCodes={ENTER:13};genotet.utils.PIXEL_TOLERANCE=.1;genotet.utils.RANGE_TOLERANCE=.001;genotet.utils.sign=function(a){return 0==a?0:0<a?1:-1};genotet.utils.rangeIntersect=function(a,b){return a[0]<b[1]-genotet.utils.RANGE_TOLERANCE&&a[1]>b[0]+genotet.utils.RANGE_TOLERANCE};genotet.utils.rectIntersect=function(a,b){var c=Math.max(a.y,b.y),d=Math.min(a.y+a.h,b.y+b.h);return Math.max(a.x,b.x)<Math.min(a.x+a.w,b.x+b.w)-genotet.utils.PIXEL_TOLERANCE&&c<d-genotet.utils.PIXEL_TOLERANCE};
genotet.utils.rectInsideWindow=function(a){return a.x>=-genotet.utils.PIXEL_TOLERANCE&&a.x+a.w<=$(window).width()+genotet.utils.PIXEL_TOLERANCE&&a.y>=-genotet.utils.PIXEL_TOLERANCE&&a.y+a.h<=$(window).height()+genotet.utils.PIXEL_TOLERANCE};genotet.utils.getTransform=function(a,b,c){var d="";null!=a&&(d+="translate("+a+")");null!=b&&(d+="scale("+b+")");null!=c&&(d+="rotate("+c+")");return d};genotet.utils.middlePoint=function(a,b){return[(a[0]+b[0])/2,(a[1]+b[1])/2]};
genotet.utils.normalizeVector=function(a){var b=genotet.utils.vectorLength(a);return genotet.utils.multiplyVector(a,1/b)};genotet.utils.mirrorPoint=function(a,b,c){c=genotet.utils.normalizeVector(genotet.utils.subtractVector(c,b));var d=genotet.utils.dotVector(genotet.utils.subtractVector(a,b),c);c=genotet.utils.multiplyVector(c,d);b=genotet.utils.addVector(b,c);a=genotet.utils.subtractVector(b,a);return genotet.utils.addVector(b,a)};genotet.utils.dotVector=function(a,b){return a[0]*b[0]+a[1]*b[1]};
genotet.utils.perpendicularVector=function(a){return[a[1],-a[0]]};genotet.utils.vectorLength=function(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1])};genotet.utils.vectorDistance=function(a,b){return genotet.utils.vectorLength(genotet.utils.subtractVector(a,b))};genotet.utils.addVector=function(a,b){return[a[0]+b[0],a[1]+b[1]]};genotet.utils.subtractVector=function(a,b){return[a[0]-b[0],a[1]-b[1]]};genotet.utils.multiplyVector=function(a,b){return[a[0]*b,a[1]*b]};
genotet.utils.randomColor=function(){var a=d3.scale.category20().range();return a[Math.floor(Math.random()*a.length)]};genotet.utils.hashString=function(a){if("string"!=typeof a)return genotet.error("x is not a string to hash");for(var b=0,c=0;c<a.length;c++)var d=a.charCodeAt(c),b=(3*b+d)%1000000007;return b};genotet.utils.encodeSpecialChar=function(a){a=a.replace(/\+/g,"%2B");return a=a.replace(/\?/g,"%3F")};genotet.utils.swap=function(a,b,c){var d=a[b];a[b]=a[c];a[c]=d};
genotet.utils.inherit=function(a,b){a.prototype=Object.create(b.prototype);a.prototype.constructor=a;a.base=b.prototype};genotet.ViewLoader=function(a){a?(this.data=a,this.loadCounter=0):genotet.error("null data passed to ViewLoader")};genotet.ViewLoader.prototype.init=function(){};genotet.ViewLoader.prototype.load=function(){};genotet.ViewLoader.prototype.update=function(){};
genotet.ViewLoader.prototype.signal=function(a,b){switch(a){case "loadStart":this.loadCounter++;this.signal("loading");break;case "loadComplete":case "loadFail":this.loadCounter--,0==this.loadCounter&&(this.signal("loaded"),"loadComplete"==a&&this.signal("loadSuccess"))}$(this).trigger("genotet."+a,[b])};genotet.ViewLoader.prototype.fail=function(a,b){genotet.error(a,null==b?"":JSON.stringify(b));this.signal("loadFail")};genotet.ViewPanel=function(a){this.data=a};genotet.ViewPanel.prototype.template="dist/html/view-panel.html";genotet.ViewPanel.prototype.create=function(a){this.container_=a;this.container_.load(this.template,function(){this.initPanel();$(this).trigger("genotet.panelReady")}.bind(this))};genotet.ViewPanel.prototype.initPanel=function(){};genotet.ViewPanel.prototype.dataLoaded=function(){};genotet.ViewPanel.prototype.signal=function(a,b){$(this).trigger("genotet."+a,[b])};genotet.ViewRenderer=function(a,b){a?(this.container=a,$(this.container).resize(this.resize.bind(this)),this.data=b):genotet.error("null container passed to ViewRenderer")};genotet.ViewRenderer.prototype.init=function(){this.canvas=d3.selectAll(this.container.find(".canvas-svg").toArray());this.initLayout();this.resize()};genotet.ViewRenderer.prototype.initLayout=function(){};genotet.ViewRenderer.prototype.layout=function(){};genotet.ViewRenderer.prototype.render=function(){};
genotet.ViewRenderer.prototype.dataLoaded=function(){};genotet.ViewRenderer.prototype.dataReady_=function(){return!1};genotet.ViewRenderer.prototype.resize=function(){this.canvasWidth_=this.container.width();this.canvasHeight_=this.container.height()-this.container.find(".view-header").outerHeight();this.canvas.attr("width",this.canvasWidth_).attr("height",this.canvasHeight_)};
genotet.ViewRenderer.prototype.showLoading=function(){var a=this.container.find(".popup");a.show();a.find(".loading").show();var b=this.container.height()-this.container.find(".view-header").outerHeight();a.css("height",b)};genotet.ViewRenderer.prototype.hideLoading=function(){this.container.find(".popup .loading").hide()};genotet.ViewRenderer.prototype.showFailure=function(){this.container.find(".popup .failure").show()};genotet.ViewRenderer.prototype.hideFailure=function(){this.container.find(".popup .failure").hide()};
genotet.ViewRenderer.prototype.signal=function(a,b){$(this).trigger("genotet."+a,[b])};genotet.View=function(a){this.viewName_=a;this.viewID_=a.replace(/\s/g,"-");this.headerText_="";this.sendSignal_=!0;this.container=$("<div></div>").addClass("view").load(this.template,function(){this.container.appendTo("#main");this.init();this.loader.init();this.renderer.init();this.container.trigger("genotet.ready")}.bind(this));this.data={options:{}}};genotet.View.prototype.template="dist/html/view.html";genotet.View.prototype.MIN_WIDTH=10;genotet.View.prototype.MIN_HEIGHT=10;
genotet.View.prototype.init=function(){this.container.draggable({handle:".view-header",snap:!0,containment:"#main",start:function(a){genotet.viewManager.blurAllViews();this.focus(this.sendSignal_)}.bind(this)}).resizable({handles:"all"}).css({width:this.defaultWidth(),height:this.defaultHeight()});var a=genotet.viewManager.findPosition(this);this.container.css(a);this.headerText(this.viewName_);this.container.click(function(a){genotet.viewManager.blurAllViews();this.focus(this.sendSignal_);a.stopPropagation()}.bind(this));
this.container.find(".close").click(function(a){genotet.viewManager.closeView(this);this.close()}.bind(this));this.container.find(".loading").click(function(a){a.stopPropagation()});$(this.loader).on("genotet.loading",function(){this.renderer.showLoading()}.bind(this)).on("genotet.loaded",function(){this.renderer.hideLoading()}.bind(this)).on("genotet.loadSuccess",function(){this.panel.dataLoaded();this.renderer.dataLoaded()}.bind(this)).on("genotet.loadFail",function(){this.renderer.showFailure()}.bind(this))};
genotet.View.prototype.name=function(a){if(!a)return this.viewName_;this.viewName_=a};genotet.View.prototype.headerText=function(a){if(!a)return this.headerText_;this.headerText_=a;this.container.find("#header-text").text(this.headerText_)};genotet.View.prototype.focus=function(a){this.container.addClass("focused");this.container.appendTo("#main");a&&this.signal("focus")};genotet.View.prototype.blur=function(){this.container.removeClass("focused")};genotet.View.prototype.close=function(){this.container.remove()};
genotet.View.prototype.rect=function(){return{x:this.container.position().left,y:this.container.position().top,w:this.container.outerWidth(),h:this.container.outerHeight()}};genotet.View.prototype.defaultWidth=function(){return 500};genotet.View.prototype.defaultHeight=function(){return this.defaultWidth()/1.6};genotet.View.prototype.createPanel=function(a){this.panel.create(a)};genotet.View.prototype.signal=function(a,b){$(this).trigger("genotet."+a,[b])};genotet.BindingLoader=function(a){genotet.BindingLoader.base.constructor.call(this,a);_(this.data).extend({tracks:[],exons:[]})};genotet.utils.inherit(genotet.BindingLoader,genotet.ViewLoader);genotet.BindingLoader.prototype.LOCUS_MARGIN_RATIO=.1;genotet.BindingLoader.prototype.load=function(a,b,c){c=c?c:this.data.tracks.length;this.data.chr=b;this.loadFullTrack(c,a,b);this.loadExons_(b)};
genotet.BindingLoader.prototype.loadFullTracks=function(){this.data.tracks.forEach(function(a){var b={type:"binding",gene:a.gene,chr:this.data.chr};this.signal("loadStart");$.get(genotet.data.serverURL,b,function(b){a.overview=b;this.updateRanges_();this.signal("loadComplete")}.bind(this),"jsonp").fail(this.fail.bind(this,"cannot load binding overview",b));_(b).extend({xl:this.data.detailXMin,xr:this.data.detailXMax});this.signal("loadStart");$.get(genotet.data.serverURL,b,function(b){a.detail=b;
this.signal("loadComplete")}.bind(this),"jsonp").fail(this.fail.bind(this,"cannot load binding detail",b))},this)};
genotet.BindingLoader.prototype.loadFullTrack=function(a,b,c){c={type:"binding",gene:b,chr:c};this.signal("loadStart");$.get(genotet.data.serverURL,c,function(c){var e=a==this.data.tracks.length;this.data.tracks[a]={gene:b,overview:c,detail:c};this.updateRanges_();this.signal("loadComplete");e&&this.loadBindingList()}.bind(this),"jsonp").fail(this.fail.bind(this,"cannot load binding overview",c));this.data.detailXMin&&(_(c).extend({xl:this.data.detailXMin,xr:this.data.detailXMax}),this.signal("loadStart"),
$.get(genotet.data.serverURL,c,function(b){this.data.tracks[a]||(this.data.tracks[a]={});this.data.tracks[a].detail=b;this.signal("loadComplete")}.bind(this),"jsonp").fail(this.fail.bind(this,"cannot load binding detail",c)))};
genotet.BindingLoader.prototype.loadTrackDetail=function(a,b){this.data.detailXMin=a;this.data.detailXMax=b;this.data.tracks.forEach(function(c){this.signal("loadStart");var d={type:"binding",gene:c.gene,chr:this.data.chr,xl:a,xr:b};$.get(genotet.data.serverURL,d,function(a){c.detail=a;this.signal("loadComplete")}.bind(this),"jsonp").fail(this.fail.bind(this,"cannot load binding detail",d))},this)};
genotet.BindingLoader.prototype.loadExons_=function(a){this.signal("loadStart");a={type:"exons",chr:a};$.get(genotet.data.serverURL,a,function(a){this.data.exons=a;this.signal("loadComplete")}.bind(this),"jsonp").fail(this.fail.bind(this,"cannot load binding data",a))};
genotet.BindingLoader.prototype.findLocus=function(a){this.signal("loadStart");a={type:"locus",gene:a};$.get(genotet.data.serverURL,a,function(a){if(a.success){var c=a.txEnd-a.txStart;this.data.detailXMin=a.txStart-c*this.LOCUS_MARGIN_RATIO;this.data.detailXMax=a.txEnd+c*this.LOCUS_MARGIN_RATIO;a.chr!=this.data.chr?(this.data.chr=a.chr,this.signal("chr",a.chr),this.switchChr(a.chr)):this.loadTrackDetail(this.data.detailXMin,this.data.detailXMax)}else genotet.warning("gene locus not found");this.signal("loadComplete")}.bind(this),
"jsonp").fail(this.fail.bind(this,"cannot search for gene locus",a))};genotet.BindingLoader.prototype.switchChr=function(a){this.data.chr=a;this.loadExons_(a);this.loadFullTracks()};
genotet.BindingLoader.prototype.updateRanges_=function(){var a=Infinity,b=-Infinity;this.data.tracks.forEach(function(c){a=Math.min(a,c.overview.xMin);b=Math.max(b,c.overview.xMax)},this);this.data.overviewRangeChanged=a!=this.data.overviewXMin||b!=this.data.overviewXMax;_(this.data).extend({overviewXMin:a,overviewXMax:b});this.data.detailXMin||_(this.data).extend({detailXMin:a,detailXMax:b})};
genotet.BindingLoader.prototype.loadBindingList=function(){$.get(genotet.data.serverURL,{type:"list-binding"},function(a){genotet.data.bindingGenes=[];a.forEach(function(a){genotet.data.bindingGenes.push(a.bindingName)});this.signal("track")}.bind(this),"jsonp").fail(function(){genotet.error("failed to get binding list")})};genotet.BindingPanel=function(a){genotet.BindingPanel.base.constructor.call(this,a);_(this.data.options).extend({autoScale:!0,showOverview:!0,showBed:!0,showExons:!0});this.selectGenes_=[]};genotet.utils.inherit(genotet.BindingPanel,genotet.ViewPanel);genotet.BindingPanel.prototype.template="dist/html/binding-panel.html";
genotet.BindingPanel.prototype.initPanel=function(){this.initChrs_();this.container_.find(".switches input").bootstrapSwitch({size:"mini"});[{selector:"#overview",type:"overview",attribute:"showOverview"},{selector:"#bed",type:"bed",attribute:"showBed"},{selector:"#exons",type:"exons",attribute:"showExons"},{selector:"#auto-scale",type:"auto-scale",attribute:"autoScale"}].forEach(function(a){this.container_.find(a.selector).on("switchChange.bootstrapSwitch",function(c,d){this.data.options[a.attribute]=
d;this.signal("update",{type:a.type})}.bind(this))},this);[{selector:"#start-coordinate",type:"start"},{selector:"#end-coordinate",type:"end"}].forEach(function(a){var c=function(){var c=+this.container_.find(a.selector+" input").val();this.signal("coordinate",{type:a.type,coordinate:c})}.bind(this);this.container_.find(a.selector+" button").click(c);this.container_.find(a.selector+" input").on("keypress",function(a){a.which==genotet.utils.keyCodes.ENTER&&c()})},this);this.selectChr_.on("select2:select",
function(a){this.signal("chr",a.params.data.id)}.bind(this));var a=function(){var a=this.container_.find("#locus input").val();this.signal("locus",a)}.bind(this);this.container_.find("#locus button").click(function(){a()});this.container_.find("#locus input").on("keypress",function(b){b.which==genotet.utils.keyCodes.ENTER&&a()});this.container_.find("#genes #add").click(function(){this.signal("addTrack")}.bind(this))};
genotet.BindingPanel.prototype.updateCoordinates=function(a,b){this.container_.find("#start-coordinate input").val(parseInt(a));this.container_.find("#end-coordinate input").val(parseInt(b))};genotet.BindingPanel.prototype.updateChr=function(a){this.selectChr_.val(a).trigger("change",[{passive:!0}])};
genotet.BindingPanel.prototype.initChrs_=function(){var a=genotet.data.bindingChrs.map(function(a,b){return{id:a,text:a}}),b=this.container_.find("#chr");this.selectChr_=b.children("select").select2({data:a});b.find(".select2-container").css({width:"100%"})};
genotet.BindingPanel.prototype.addTrack_=function(){var a=this.data.tracks.length-1,b=this.container_.find("#genes #tracks"),b=b.find("#track-template").clone().appendTo(b).attr("id","track-"+a).show(),c=genotet.data.bindingGenes.map(function(a,b){return{id:a,text:a}}),d=this.data.tracks[a].gene,c=b.children("select").select2({data:c});c.val(d).trigger("change");this.selectGenes_[a]=c;b.find(".select2-container").css({width:"calc(100% - 30px)"});b.find("#remove").click(this.signal.bind(this,"removeTrack",
a));c.on("select2:select",function(b){this.signal("gene",{trackIndex:a,gene:b.params.data.id})}.bind(this))};
genotet.BindingPanel.prototype.updateTracks=function(){var a=this.data.tracks.length,b=this.container_.find("#genes .track-gene");if(b.length>a)for(b=b.length-1;b>=a;b--)this.container_.find("#genes #track-"+b).remove();this.data.tracks.forEach(function(a,b){this.container_.find("#genes #track-"+b).length||(this.addTrack_(),$("#gene #track-"+b));this.selectGenes_[b].val(a.gene).trigger("change")},this);this.container_.find("#genes .glyphicon-remove").css("display",1==this.data.tracks.length?"none":
"")};genotet.BindingRenderer=function(a,b){genotet.BindingRenderer.base.constructor.call(this,a,b);this.detailHeight_=0;this.zoomTranslate_=[0,0];this.zoomScale_=1;this.zoom_=d3.behavior.zoom();this.xScaleOverview_=d3.scale.linear();this.xScaleZoom_=d3.scale.linear()};genotet.utils.inherit(genotet.BindingRenderer,genotet.ViewRenderer);genotet.BindingRenderer.prototype.EXON_HEIGHT=35;genotet.BindingRenderer.prototype.EXON_SIZE=10;genotet.BindingRenderer.prototype.EXON_CENTER_Y=20;
genotet.BindingRenderer.prototype.EXON_LABEL_OFFSET=3;genotet.BindingRenderer.prototype.OVERVIEW_HEIGHT=25;genotet.BindingRenderer.prototype.EXON_ABSTRACT_LIMIT=200;genotet.BindingRenderer.prototype.STRAND_HORIZONTAL_SIZE=5;genotet.BindingRenderer.prototype.STRAND_VERTICAL_SIZE=3;genotet.BindingRenderer.prototype.EXON_LABEL_SIZE=6;genotet.BindingRenderer.ZOOM_EXTENT=[1,65536];genotet.BindingRenderer.ZOOM_INTERVAL=500;
genotet.BindingRenderer.prototype.init=function(){genotet.BindingRenderer.base.init.call(this);this.zoom_=d3.behavior.zoom().scaleExtent(genotet.BindingRenderer.ZOOM_EXTENT).on("zoom",this.zoomHandler_.bind(this)).on("zoomend",this.zoomEndHandler_.bind(this));this.detailHandle_.call(this.zoom_);this.exonsHandle_.call(this.zoom_);var a=[];this.drag_=d3.behavior.drag().on("drag",function(){var b=d3.event.x;null==a[0]?a[0]=b:(a[1]=b,this.drawOverviewRange_([this.xScaleOverview_.invert(Math.min(a[0],
a[1])),this.xScaleOverview_.invert(Math.max(a[0],a[1]))]))}.bind(this)).on("dragend",function(){null!=a[0]&&null!=a[1]&&(this.zoomDetail_([this.xScaleOverview_.invert(Math.min(a[0],a[1])),this.xScaleOverview_.invert(Math.max(a[0],a[1]))]),a=[])}.bind(this));this.overviewHandle_.call(this.drag_)};
genotet.BindingRenderer.prototype.getBindingRanges_=function(){this.data.overviewRangeChanged&&(this.xScaleZoom_.domain([this.data.overviewXMin,this.data.overviewXMax]).range([0,this.canvasWidth_]),this.zoom_.x(this.xScaleZoom_),this.zoomTranslate_=[0,0],this.zoomScale_=1,this.xScaleOverview_.domain([this.data.overviewXMin,this.data.overviewXMax]).range([0,this.canvasWidth_]),this.detailContent_.attr("transform",""))};
genotet.BindingRenderer.prototype.dataLoaded=function(){this.getBindingRanges_();this.render();this.signal("coordinates",{start:this.data.detailXMin,end:this.data.detailXMax})};
genotet.BindingRenderer.prototype.initLayout=function(){this.svgOverview_=this.canvas.append("g").classed("overviews",!0);this.svgDetail_=this.canvas.append("g").classed("details",!0);this.svgExons_=this.canvas.append("g").classed("exons",!0);this.overviewContent_=this.svgOverview_.append("g").classed("content",!0);this.detailContent_=this.svgDetail_.append("g").classed("content",!0);this.exonsContent_=this.svgExons_.append("g").classed("content",!0);this.overviewRange_=this.overviewContent_.append("rect").classed("range",
!0);this.overviewHandle_=this.svgOverview_.append("rect").classed("zoom-handle",!0);this.detailHandle_=this.svgDetail_.append("rect").classed("zoom-handle",!0);this.exonsHandle_=this.svgExons_.append("rect").classed("zoom-handle",!0)};
genotet.BindingRenderer.prototype.layout=function(){this.updateDetailHeight_();this.updateZoomHandles_();var a=this.data.tracks.length;this.detailTranslateY_=this.data.options.showOverview?a*this.OVERVIEW_HEIGHT:0;this.exonsTranslateY_=this.canvasHeight_-this.EXON_HEIGHT;this.svgDetail_.attr("transform",genotet.utils.getTransform([0,this.detailTranslateY_]));this.svgExons_.attr("transform",genotet.utils.getTransform([0,this.exonsTranslateY_]));var a=function(a,b){return"track-"+b},b=this.overviewContent_.selectAll("g").data(this.data.tracks);
b.enter().append("g").attr("id",a);b.exit().remove();b.attr("height",this.OVERVIEW_HEIGHT).attr("transform",function(a,b){return genotet.utils.getTransform([0,this.OVERVIEW_HEIGHT*b])}.bind(this));b=this.detailContent_.selectAll("g").data(this.data.tracks);b.enter().append("g").attr("id",a);b.exit().remove();b.attr("height",this.detailHeight_).attr("transform",function(a,b){return genotet.utils.getTransform([0,this.detailHeight_*b])}.bind(this))};
genotet.BindingRenderer.prototype.render=function(){this.dataReady_()&&(this.layout(),this.zoomTransform([this.data.detailXMin,this.data.detailXMax]),this.drawOverviews_(),this.drawDetails_(),this.drawBed_(),this.drawExons_())};
genotet.BindingRenderer.prototype.drawOverviews_=function(){if(this.data.options.showOverview){this.overviewContent_.style("display","");var a=d3.scale.linear().domain([this.data.overviewXMin,this.data.overviewXMax]).range([0,this.canvasWidth_]);this.data.tracks.forEach(function(b,c){var d=this.overviewContent_.select("#track-"+c);this.drawHistogram_(d,b.overview,a)},this);this.drawOverviewRange_()}else this.overviewContent_.style("display","none")};
genotet.BindingRenderer.prototype.drawDetails_=function(){this.data.tracks.forEach(function(a,b){var c=this.detailContent_.select("#track-"+b);this.drawHistogram_(c,a.detail,this.xScaleOverview_)},this)};
genotet.BindingRenderer.prototype.drawHistogram_=function(a,b,c){if(b.values.length){var d=a.attr("height"),e=d3.scale.linear().domain([0,this.data.options.autoScale?b.valueMax:b.allValueMax]).range([0,d]);c(b.xMax);c(b.xMin);var f=a.select(".histogram");f.empty()&&(f=a.append("path").classed("histogram",!0));var g=d3.svg.line().interpolate("linear-closed"),h=0,k=b.values.map(function(a){h=c(a.x);return[h,d-e(a.value)]});k.push([h,d]);k.push([c(b.values[0].x),d]);f.attr("d",g(k));a.select(".baseline").empty()&&
a.append("line").classed("baseline",!0);a.select(".baseline").attr("transform",genotet.utils.getTransform([0,d])).attr("x1",0).attr("x2",this.canvasWidth_)}else a.select(".histogram").remove()};genotet.BindingRenderer.prototype.drawOverviewRange_=function(a){a=a?a:[this.data.detailXMin,this.data.detailXMax];var b=this.xScaleOverview_;this.overviewRange_.attr("height",this.OVERVIEW_HEIGHT*this.data.tracks.length).attr("x",b(a[0])).attr("width",b(a[1])-b(a[0]))};
genotet.BindingRenderer.prototype.drawExons_=function(){if(this.data.options.showExons){this.exonsContent_.style("display","");var a=[],b=[this.data.detailXMin,this.data.detailXMax];this.data.exons.forEach(function(c){genotet.utils.rangeIntersect([c.txStart,c.txEnd],b)&&a.push(c)},this);var c=this.xScaleZoom_,d=function(a){var b=c((a.txStart+a.txEnd)/2);a=a.name2.length/2*this.EXON_LABEL_SIZE;return[b-a,b+a]}.bind(this);a.sort(function(a,b){var c=d(a),e=d(b);return c[0]-e[0]||c[1]-e[1]});var e=this.EXON_CENTER_Y,
f=e-this.EXON_SIZE/4,g=e-this.EXON_SIZE/2;if(a.length>this.EXON_ABSTRACT_LIMIT){this.exonsContent_.selectAll("g.exon").remove();var h=this.exonsContent_.selectAll(".abstract").data(a);h.enter().append("rect").classed("abstract",!0).attr("y",g);h.exit().remove();h.attr("x",function(a){return c(a.txStart)}).attr("width",function(a){return c(a.txEnd)-c(a.txStart)}).attr("height",this.EXON_SIZE)}else{this.exonsContent_.selectAll(".abstract").remove();var h=this.exonsContent_.selectAll("g.exon").data(a,
function(a){return a.name2}),k=h.enter().append("g").classed("exon",!0);k.append("text");k.append("line");h.exit().remove();h.select("line").attr("y1",e).attr("y2",e).attr("x1",function(a){return c(a.txStart)}).attr("x2",function(a){return c(a.txEnd)});k=h.selectAll(".txbox").data(function(a){return a.txRanges},function(a){return a.name2});k.enter().append("rect").classed("txbox",!0).attr("y",f).attr("height",this.EXON_SIZE/2);k.exit().remove();k.attr("x",function(a){return c(a.start)}).attr("width",
function(a){return c(a.end)-c(a.start)});f=h.selectAll(".box").data(function(a){return a.exRanges});f.enter().append("rect").classed("box",!0).attr("y",g).attr("height",this.EXON_SIZE);f.exit().remove();f.attr("x",function(a){return c(a.start)}).attr("width",function(a){return c(a.end)-c(a.start)});var f=h.selectAll(".strand").data(function(a){for(var b=[],c=.25;.75>=c;c+=.25)b.push({x:a.txStart*(1-c)+a.txEnd*c,direction:a.strand});return b}),m=d3.svg.line();f.enter().append("path").classed("strand",
!0);f.exit().remove();f.attr("d",function(a){var b=c(a.x);return m([[b+("+"==a.direction?this.STRAND_HORIZONTAL_SIZE:-this.STRAND_HORIZONTAL_SIZE),e],[b,e+this.STRAND_VERTICAL_SIZE],[b,e-this.STRAND_VERTICAL_SIZE]])}.bind(this));var g=g-this.EXON_LABEL_OFFSET,l=-Infinity;h.select("text").attr("y",g).attr("x",function(a){return c((a.txStart+a.txEnd)/2)}).text(function(a){var b=d(a);if(b[0]<l)return"";l=Math.max(l,b[1]);return a.name2}.bind(this))}}else this.exonsContent_.style("display","none")};
genotet.BindingRenderer.prototype.drawBed_=function(){};genotet.BindingRenderer.prototype.updateDetailHeight_=function(){var a=this.data.tracks.length;this.detailHeight_=(this.canvasHeight_-(this.data.options.showExons?this.EXON_HEIGHT:0)-(this.data.options.showOverview?this.OVERVIEW_HEIGHT*a:0))/(a?a:1)};
genotet.BindingRenderer.prototype.resize=function(){genotet.BindingRenderer.base.resize.call(this);this.updateZoomHandles_();this.dataReady_()&&(this.xScaleOverview_.range([0,this.canvasWidth_]),this.xScaleZoom_.domain([this.data.overviewXMin,this.data.overviewXMax]).range([0,this.canvasWidth_]),this.zoom_.x(this.xScaleZoom_),this.render())};
genotet.BindingRenderer.prototype.updateZoomHandles_=function(){var a=this.data.tracks.length,a=[this.OVERVIEW_HEIGHT*a,this.detailHeight_*a,this.EXON_HEIGHT];this.canvas.selectAll(".zoom-handle").data(a).attr("height",_.identity)};
genotet.BindingRenderer.prototype.zoomHandler_=function(){clearTimeout(this.zoomTimer_);var a=d3.event.translate,b=d3.event.scale;a[0]=Math.max(this.canvasWidth_*(1-b),a[0]);a[0]=Math.min(0,a[0]);a[1]=0;this.zoomTranslate_=a;this.zoomScale_=b;this.zoom_.translate(a);a=genotet.utils.getTransform(a,[b,1]);this.detailContent_.attr("transform",a);a=this.screenRangeToBindingCoordinates_();this.drawOverviewRange_(a);this.signal("coordinates",{start:a[0],end:a[1]});this.drawDetails_();this.drawExons_()};
genotet.BindingRenderer.prototype.zoomEndHandler_=function(){clearTimeout(this.zoomTimer_);this.zoomTimer_=setTimeout(this.zoomDetail_.bind(this),genotet.BindingRenderer.ZOOM_INTERVAL)};genotet.BindingRenderer.prototype.screenRangeToBindingCoordinates_=function(a){a=a?a:[0,this.canvasWidth_];var b=this.xScaleZoom_.invert;return[b(a[0]),b(a[1])]};genotet.BindingRenderer.prototype.zoomDetail_=function(a){a=a?a:this.screenRangeToBindingCoordinates_();this.signal("zoom",{xl:a[0],xr:a[1]})};
genotet.BindingRenderer.prototype.zoomTransform=function(a){var b=(this.data.overviewXMax-this.data.overviewXMin)/(a[1]-a[0]),c=[-this.xScaleOverview_(a[0])*b,0];this.zoomTranslate_=c;this.zoomScale_=b;this.xScaleZoom_.domain(a);this.zoom_.scale(b).translate(c);this.detailContent_.attr("transform",genotet.utils.getTransform(c,[b,1]))};genotet.BindingRenderer.prototype.dataReady_=function(){return 0<this.data.tracks.length};genotet.BindingView=function(a,b){genotet.BindingView.base.constructor.call(this,a);this.container.addClass("binding");this.loader=new genotet.BindingLoader(this.data);this.panel=new genotet.BindingPanel(this.data);this.renderer=new genotet.BindingRenderer(this.container,this.data);$(this.container).on("genotet.ready",function(){this.loader.load(b.gene,b.chr)}.bind(this));$(this.renderer).on("genotet.zoom",function(a,b){this.loader.loadTrackDetail(b.xl,b.xr)}.bind(this)).on("genotet.coordinates",
function(a,b){this.panel.updateCoordinates(b.start,b.end)}.bind(this));$(this.panel).on("genotet.coordinate",function(a,b){var e="start"==b.type?[b.coordinate,this.data.detailXMax]:[this.data.detailXMin,b.coordinate];e[0]>e[1]?genotet.warning("start coordinate must be <= end coordinate:",e):e[0]<this.data.overviewXMin||e[1]>this.data.overviewXMax?genotet.warning("coordinate out of range",[this.data.overviewXMin,this.data.overviewXMax]):(this.loader.loadTrackDetail(e[0],e[1]),this.renderer.zoomTransform(e))}.bind(this)).on("genotet.locus",
function(a,b){b?this.loader.findLocus(b):genotet.warning("please enter gene name")}.bind(this)).on("genotet.chr",function(a,b){this.loader.switchChr(b)}.bind(this)).on("genotet.update",function(a,b){this.renderer.render()}.bind(this)).on("genotet.addTrack",function(){var a=this.data.tracks.slice(-1).pop();this.loader.loadFullTrack(this.data.tracks.length,a.gene,this.data.chr)}.bind(this)).on("genotet.removeTrack",function(a,b){this.data.tracks.splice(b,1);this.renderer.render();this.panel.updateTracks()}.bind(this)).on("genotet.gene",
function(a,b){this.data.tracks[b.trackIndex].gene=b.gene;this.loader.loadFullTrack(b.trackIndex,b.gene,this.data.chr)}.bind(this));$(this.loader).on("genotet.chr",function(a,b){this.panel.updateChr(b)}.bind(this)).on("genotet.track",function(a){this.panel.updateTracks()}.bind(this))};genotet.utils.inherit(genotet.BindingView,genotet.View);genotet.BindingView.prototype.defaultWidth=function(){return Math.max(this.MIN_WIDTH,$(window).width()-genotet.panelManager.COLLAPSED_WIDTH)};
genotet.BindingView.prototype.defaultHeight=function(){return 200};genotet.ExpressionLoader=function(a){genotet.ExpressionLoader.base.constructor.call(this,a);_(this.data).extend({matrix:null,profiles:[]})};genotet.utils.inherit(genotet.ExpressionLoader,genotet.ViewLoader);genotet.ExpressionLoader.prototype.load=function(a,b,c){this.loadExpressionMatrix_(a,b,c)};
genotet.ExpressionLoader.prototype.loadExpressionMatrix_=function(a,b,c){this.signal("loadStart");var d={type:"read-expression",matrixName:a,geneRegex:b,conditionRegex:c};$.get(genotet.data.serverURL,d,function(d){_(d).extend({matrixname:a,geneRegex:b,conditionRegex:c});this.data.matrix=d;this.signal("loadComplete")}.bind(this),"jsonp").fail(this.fail.bind(this,"cannot load expression matrix",d))};
genotet.ExpressionLoader.prototype.update=function(a,b,c){var d=this.data.matrix.geneRegex,e=this.data.matrix.conditionRegex;c=c.toUpperCase();switch(a){case "setGene":d=c;break;case "addGene":d+="|"+c;break;case "removeGene":d="";this.data.matrix.geneNames.forEach(function(a){a.match(c)||(d+=a+"|")});d=d.slice(0,-1);break;case "setCondition":e=c;break;case "addCondition":e+="|"+c;break;case "removeCondition":e="",this.data.matrix.conditionNames.forEach(function(a){a.match(c)||(e+=a+"|")}),e=e.slice(0,
-1)}this.load(b,d,e)};genotet.ExpressionPanel=function(a){genotet.ExpressionPanel.base.constructor.call(this,a);_(this.data.options).extend({showGeneLabels:!0,showConditionLabels:!1,showProfiles:!0,showGradient:!1,autoScaleGradient:!0})};genotet.utils.inherit(genotet.ExpressionPanel,genotet.ViewPanel);genotet.ExpressionPanel.prototype.template="dist/html/expression-panel.html";genotet.ExpressionPanel.prototype.dataLoaded=function(){this.updateGenes(this.data.matrix.geneNames)};
genotet.ExpressionPanel.prototype.initPanel=function(){this.updateGenes([]);this.container_.find(".switches input").bootstrapSwitch({size:"mini"});[{selector:"#label-genes",type:"label",attribute:"showGeneLabels"},{selector:"#label-conditions",type:"label",attribute:"showConditionLabels"},{selector:"#show-profiles",type:"visibility",attribute:"showProfiles"},{selector:"#auto-scale",type:"auto-scale",attribute:"autoScaleGradient"}].forEach(function(a){this.container_.find(a.selector).on("switchChange.bootstrapSwitch",
function(b,c){this.data.options[a.attribute]=c;this.signal("update",{type:a.type})}.bind(this))},this);this.selectProfiles_.on("select2:select",function(a){this.signal("addGeneProfile",a.params.data.element.index)}.bind(this)).on("select2:unselect",function(a){this.signal("removeGeneProfile",a.params.data.element.index)}.bind(this));["setGene","addGene","removeGene"].forEach(function(a){this.container_.find("#genes #"+a).click(function(){var b=this.container_.find("#genes input"),c=b.val();""==c?
genotet.warning("missing input gene selection"):(b.val(""),this.signal("update",{type:"gene",regex:c,method:a}))}.bind(this))},this);["setCondition","addCondition","removeCondition"].forEach(function(a){this.container_.find("#conditions #"+a).click(function(){var b=this.container_.find("#conditions input"),c=b.val();""==c?genotet.warning("missing input condition selection"):(b.val(""),this.signal("update",{type:"condition",regex:c,method:a}))}.bind(this))},this)};
genotet.ExpressionPanel.prototype.updateGenes=function(a){a=a.map(function(a){return{id:a,text:a}});this.selectProfiles_=this.container_.find("#profile select").empty();this.selectProfiles_.select2({data:a,multiple:!0});this.container_.find("#profile .select2-container").css({width:"100%"})};
genotet.ExpressionPanel.prototype.setCellInfo_=function(a,b,c,d){d.html(this.container_.find("#cell-info-template").html());d.children("#gene").children("span").text(a);d.children("#condition").children("span").text(b);d.children("#value").children("span").text(c)};genotet.ExpressionPanel.prototype.hideCellInfo_=function(){this.container_.find("#cell-info").slideUp()};genotet.ExpressionPanel.prototype.tooltipHeatmap_=function(a,b,c){var d=genotet.tooltip.create();this.setCellInfo_(a,b,c,d);d.find(".close").remove()};
genotet.ExpressionPanel.prototype.displayCellInfo_=function(a,b,c){var d=this.container_.find("#cell-info").hide().slideDown();this.setCellInfo_(a,b,c,d);d.find(".close").click(function(){this.hideCellInfo_()}.bind(this))};genotet.ExpressionPanel.prototype.setPathInfo_=function(a,b,c,d){d.html(this.container_.find("#profile-info-template").html());d.children("#genePath").children("span").text(a);d.children("#conditionPath").children("span").text(b);d.children("#profileValue").children("span").text(c)};
genotet.ExpressionPanel.prototype.hidePathInfo_=function(){this.container_.find("#profile-info").slideUp()};genotet.ExpressionPanel.prototype.tooltipGeneProfile_=function(a,b,c){var d=genotet.tooltip.create();this.setPathInfo_(a,b,c,d);d.find(".close").remove()};genotet.ExpressionPanel.prototype.displayPathInfo_=function(a,b,c){var d=this.container_.find("#profile-info").hide().slideDown();this.setPathInfo_(a,b,c,d);d.find(".close").click(function(){this.hidePathInfo_()}.bind(this))};genotet.ExpressionRenderer=function(a,b){genotet.ExpressionRenderer.base.constructor.call(this,a,b);this.cell_={container_:null,geneName:null,conditionName:null,row:0,column:0,value:0,colorscaleValue:null};this.profile_={container_:null,geneName:null,row:0,hoverColumn:0,hoverConditionName:null,hoverValue:0,color:null};this.geneLabelWidth_=0;this.GENE_LABEL_WIDTH_FACTOR_=8.725;this.conditionLabelHeight_=0;this.CONDITION_LABEL_HEIGHT_FACTOR_=6.501175;this.LABEL_MARGIN_=10;this.TEXT_HEIGHT_=14.5;this.COLOR_CATEGORY_SIZE_=
60;this.COLOR_CATEGORY_=d3.scale.category20().range().concat(d3.scale.category20b().range()).concat(d3.scale.category20c().range());this.PROFILE_MARGINS_={TOP:10,RIGHT:0,BOTTOM:20,LEFT:40};this.profileHeight_=this.DEFAULT_PROFILE_HEIGHT;this.geneProfileMargin_=this.heatmapHeight_=this.heatmapWidth_=0};genotet.utils.inherit(genotet.ExpressionRenderer,genotet.ViewRenderer);genotet.ExpressionRenderer.prototype.DEFAULT_PROFILE_HEIGHT=150;genotet.ExpressionRenderer.prototype.DEFAULT_PROFILE_MARGIN=40;
genotet.ExpressionRenderer.prototype.init=function(){genotet.ExpressionRenderer.base.init.call(this)};
genotet.ExpressionRenderer.prototype.initLayout=function(){this.svgProfile_=this.canvas.append("g").classed("profiles",!0).classed("height",this.DEFAULT_PROFILE_HEIGHT);this.svgHeatmap_=this.canvas.append("g").classed("heatmap",!0);this.svgHeatmapContent_=this.svgHeatmap_.append("g").classed("content",!0);this.svgGeneLabels_=this.svgHeatmap_.append("g").classed("gene-labels",!0);this.svgConditionLabels_=this.svgHeatmap_.append("g").classed("condition-labels",!0)};
genotet.ExpressionRenderer.prototype.layout=function(){this.getHeatmapLabelSizes_();this.profileHeight_=this.data.options.showProfiles?this.DEFAULT_PROFILE_HEIGHT:0;this.svgHeatmap_.attr("transform",genotet.utils.getTransform([0,0]));this.heatmapWidth_=this.canvasWidth_-this.geneLabelWidth_;this.data.options.showGeneLabels&&(this.heatmapWidth_-=this.LABEL_MARGIN_);this.heatmapHeight_=this.canvasHeight_-this.profileHeight_-this.conditionLabelHeight_;this.data.options.showConditionLabels&&(this.heatmapHeight_-=
this.LABEL_MARGIN_);this.svgHeatmapContent_.attr("transform",genotet.utils.getTransform([this.geneLabelWidth_,0]));this.svgConditionLabels_.attr("transform",genotet.utils.getTransform([this.geneLabelWidth_,0]))};genotet.ExpressionRenderer.prototype.dataLoaded=function(){this.render()};genotet.ExpressionRenderer.prototype.dataReady_=function(){return this.data.matrix};genotet.ExpressionRenderer.prototype.render=function(){this.dataReady_()&&(this.layout(),this.drawExpressionMatrix_(),this.drawGeneProfiles_())};
genotet.ExpressionRenderer.prototype.drawExpressionMatrix_=function(){this.drawMatrixCells_();this.drawMatrixGeneLabels_();this.drawMatrixConditionLabels_()};
genotet.ExpressionRenderer.prototype.drawMatrixCells_=function(){var a=this.data.matrix,b=this.heatmapWidth_/a.conditionNames.length,c=this.heatmapHeight_/a.geneNames.length,d=d3.scale.linear();this.data.options.autoScaleGradient?d.domain([a.valueMin,(a.valueMin+a.valueMax)/2,a.valueMax]).range(genotet.data.redYellowScale):d.domain([a.allValueMin,(a.allValueMin+a.allValueMax)/2,a.allValueMax]).range(genotet.data.redYellowScale);var e=0,f=this.conditionLabelHeight_+this.profileHeight_;this.data.options.showGeneLabels?
e+=this.LABEL_MARGIN_:this.data.options.showProfiles&&(e+=this.DEFAULT_PROFILE_MARGIN);this.data.options.showConditionLabels&&(f+=this.LABEL_MARGIN_);var g=this.svgHeatmapContent_.selectAll("g").data(a.values);g.enter().append("g");g.attr("transform",genotet.utils.getTransform([e,f]));g.exit().remove();e=g.selectAll("rect").data(_.identity);e.enter().append("rect");e.attr("width",b).attr("height",c).attr("x",function(a,c){return c*b}).attr("y",function(a,b,d){return d*c}).style("stroke",d).style("fill",
d).on("mouseover",function(b,c,d){b=this.cell_={container_:d3.event.target,geneName:a.geneNames[d],conditionName:a.conditionNames[c],row:d,column:c,value:b};this.signal("cellHover",b)}.bind(this)).on("mouseout",function(a){a=this.cell_={container_:d3.event.target,colorscaleValue:d(a)};this.signal("cellUnhover",a)}.bind(this)).on("click",function(b,c,d){b=this.cell_={container_:d3.event.target,geneName:a.geneNames[d],conditionName:a.conditionNames[c],row:d,column:c,value:b};this.signal("cellClick",
b)}.bind(this));e.exit().remove()};
genotet.ExpressionRenderer.prototype.drawMatrixGeneLabels_=function(){if(this.data.options.showGeneLabels){this.svgGeneLabels_.selectAll("*").attr("display","inline");var a=this.data.matrix.geneNames,b=this.heatmapHeight_/a.length,c=this.profileHeight_+this.TEXT_HEIGHT_/2+b/2;this.data.options.showConditionLabels&&(c+=this.conditionLabelHeight_+this.LABEL_MARGIN_);a=this.svgGeneLabels_.selectAll("text").data(a);a.enter().append("text").classed("gene-label",!0);a.exit().remove();a.attr("transform",
genotet.utils.getTransform([this.geneLabelWidth_,c])).text(_.identity).attr("x",0).attr("y",function(a,c){return c*b})}else this.svgGeneLabels_.selectAll("*").attr("display","none")};
genotet.ExpressionRenderer.prototype.drawMatrixConditionLabels_=function(){if(this.data.options.showConditionLabels){this.svgConditionLabels_.selectAll("*").attr("display","inline");var a=this.data.matrix.conditionNames,b=this.heatmapWidth_/a.length,c=this.TEXT_HEIGHT_/2+b/2;this.data.options.showGeneLabels?c+=this.LABEL_MARGIN_:this.data.options.showProfiles&&(c+=this.DEFAULT_PROFILE_MARGIN);a=this.svgConditionLabels_.selectAll("text").data(a);a.enter().append("text").classed("condition-label",!0);
a.exit().remove();a.attr("transform",genotet.utils.getTransform([c,this.conditionLabelHeight_+this.profileHeight_],1,-90)).text(_.identity).attr("x",0).attr("y",function(a,c){return c*b})}else this.svgConditionLabels_.selectAll("*").attr("display","none")};
genotet.ExpressionRenderer.prototype.drawGeneProfiles_=function(){if(this.data.options.showProfiles){this.PROFILE_MARGINS_.LEFT=this.data.options.showGeneLabels?this.geneLabelWidth_+this.LABEL_MARGIN_:this.DEFAULT_PROFILE_MARGIN;this.svgProfile_.selectAll("*").attr("display","inline");var a=this.data.matrix;this.svgProfile_.selectAll("g").remove();this.svgProfile_.attr("width",this.canvasWidth_);var b=d3.scale.linear().range([this.PROFILE_MARGINS_.LEFT,this.canvasWidth_-this.PROFILE_MARGINS_.RIGHT]).domain([0,
a.conditionNames.length]),c=d3.scale.linear().range([this.profileHeight_-this.PROFILE_MARGINS_.BOTTOM,this.PROFILE_MARGINS_.TOP]).domain([a.valueMin,a.valueMax]),d=d3.svg.axis().scale(b).orient("bottom"),e=d3.svg.axis().scale(c).orient("left");this.svgProfile_.append("svg:g").call(d).classed("axis",!0).classed("x",!0).attr("transform","translate(0, "+(this.profileHeight_-this.PROFILE_MARGINS_.BOTTOM)+")");this.svgProfile_.append("svg:g").call(e).classed("axis",!0).attr("transform","translate("+this.PROFILE_MARGINS_.LEFT+
", 0)");var f=this.svgProfile_.append("g").attr("width",this.canvasWidth_-this.PROFILE_MARGINS_.LEFT-this.PROFILE_MARGINS_.RIGHT).attr("height",this.profileHeight_-this.PROFILE_MARGINS_.TOP-this.PROFILE_MARGINS_.BOTTOM),g=d3.svg.line().x(function(a,c){return b(c)}).y(c).interpolate("linear");this.data.profiles.forEach(function(c,d){var e=this.data.profiles[d].row,l=this.COLOR_CATEGORY_[genotet.utils.hashString(a.geneNames[e])%this.COLOR_CATEGORY_SIZE_];this.data.profiles[d]={geneName:a.geneNames[e],
row:e,color:l};f.append("path").classed("profile",!0).attr("d",g(a.values[e])).attr("transform","translate("+this.heatmapWidth_/(2*a.conditionNames.length)+", 0)").attr("stroke",l).attr("fill","none").on("mousemove",function(){var c=Math.floor(b.invert(d3.mouse(d3.event.target)[0])+.5),g=a.values[e][c];_(this.data.profiles[d]).extend({container_:d3.event.target,hoverColumn:c,hoverConditionName:a.conditionNames[c],hoverValue:g});this.signal("pathHover",this.data.profiles[d])}.bind(this)).on("mouseout",
function(){this.data.profiles[d].container_=d3.event.target;this.signal("pathUnhover",this.data.profiles[d])}.bind(this)).on("click",function(){var c=Math.floor(b.invert(d3.mouse(d3.event.target)[0])+.5),g=a.values[e][c];_(this.data.profiles[d]).extend({container_:d3.event.target,hoverColumn:c,hoverConditionName:a.conditionNames[c],hoverValue:g});this.signal("pathClick",this.data.profiles[d])}.bind(this))},this)}else this.svgProfile_.selectAll("*").attr("display","none")};
genotet.ExpressionRenderer.prototype.addGeneProfile_=function(a){a=this.profile_={row:a};this.data.profiles.push(a);this.drawGeneProfiles_()};genotet.ExpressionRenderer.prototype.removeGeneProfile_=function(a){for(var b=-1,c=0;c<this.data.profiles.length;c++)if(this.data.profiles[c].row==a){b=c;break}this.data.profiles.splice(b,1);this.drawGeneProfiles_()};
genotet.ExpressionRenderer.prototype.highlightHoverCell_=function(a){d3.select(a.container_).style("stroke","white");this.svgGeneLabels_.selectAll("text").classed("highlighted",function(b,c){return a.row==c});this.svgConditionLabels_.selectAll("text").classed("highlighted",function(b,c){return a.column==c})};
genotet.ExpressionRenderer.prototype.unhighlightHoverCell_=function(a){d3.select(a.container_).style("stroke",a.colorscaleValue);this.svgGeneLabels_.selectAll("text").classed("highlighted",!1);this.svgConditionLabels_.selectAll("text").classed("highlighted",!1)};
genotet.ExpressionRenderer.prototype.highlightHoverPath_=function(a){d3.select(a.container_).classed("highlighted",!0);this.svgGeneLabels_.selectAll("text").classed("highlighted",function(b,c){return a.row==c});this.svgConditionLabels_.selectAll("text").classed("highlighted",function(b,c){return a.hoverColumn==c})};
genotet.ExpressionRenderer.prototype.unhighlightHoverPath_=function(a){d3.select(a.container_).classed("highlighted",!1);this.svgGeneLabels_.selectAll("text").classed("highlighted",!1);this.svgConditionLabels_.selectAll("text").classed("highlighted",!1)};
genotet.ExpressionRenderer.prototype.highlightLabelsForClickedCell_=function(a){this.svgGeneLabels_.selectAll("text").classed("click-highlighted",function(b,c){return a.row==c});this.svgConditionLabels_.selectAll("text").classed("click-highlighted",function(b,c){return a.column==c})};
genotet.ExpressionRenderer.prototype.highlightLabelsForClickedProfile_=function(a){this.svgGeneLabels_.selectAll("text").attr("fill","black");this.svgConditionLabels_.selectAll("text").attr("fill","black");this.svgGeneLabels_.select("text:nth-child("+(a.row+1)+")").attr("fill",a.color);this.svgConditionLabels_.select("text:nth-child("+(a.hoverColumn+1)+")").attr("fill",a.color)};
genotet.ExpressionRenderer.prototype.getHeatmapLabelSizes_=function(){var a=this.data.matrix,b=a.geneNames,a=a.conditionNames;this.conditionLabelHeight_=this.geneLabelWidth_=0;this.data.options.showGeneLabels&&(this.geneLabelWidth_=d3.max(b.map(function(a){return a.length})),this.geneLabelWidth_*=this.GENE_LABEL_WIDTH_FACTOR_);this.data.options.showConditionLabels&&(this.conditionLabelHeight_=d3.max(a.map(function(a){return a.length})),this.conditionLabelHeight_*=this.CONDITION_LABEL_HEIGHT_FACTOR_)};
genotet.ExpressionRenderer.prototype.resize=function(){genotet.ExpressionRenderer.base.resize.call(this);this.render()};genotet.ExpressionView=function(a,b){genotet.ExpressionView.base.constructor.call(this,a);this.container.addClass("expression");this.loader=new genotet.ExpressionLoader(this.data);this.panel=new genotet.ExpressionPanel(this.data);this.renderer=new genotet.ExpressionRenderer(this.container,this.data);$(this.container).on("genotet.ready",function(){this.loader.load(b.matrixName,b.geneRegex,b.condRegex)}.bind(this));$(this.panel).on("genotet.update",function(a,d){switch(d.type){case "label":this.renderer.render();
break;case "visibility":this.renderer.render();break;case "gene":this.loader.update(d.method,b.matrixName,d.regex);break;case "condition":this.loader.update(d.method,b.matrixName,d.regex);break;case "auto-scale":this.renderer.render();break;default:genotet.error("unknown update type",d.type)}}.bind(this)).on("genotet.addGeneProfile",function(a,b){this.renderer.addGeneProfile_(b)}.bind(this)).on("genotet.removeGeneProfile",function(a,b){this.renderer.removeGeneProfile_(b)}.bind(this));$(this.renderer).on("genotet.cellHover",
function(a,b){this.renderer.highlightHoverCell_(b);this.panel.tooltipHeatmap_(b.geneName,b.conditionName,b.value)}.bind(this)).on("genotet.cellUnhover",function(a,b){this.renderer.unhighlightHoverCell_(b);genotet.tooltip.hideAll()}.bind(this)).on("genotet.cellClick",function(a,b){this.renderer.highlightLabelsForClickedCell_(b);this.panel.displayCellInfo_(b.geneName,b.conditionName,b.value)}.bind(this));$(this.renderer).on("genotet.pathHover",function(a,b){this.renderer.highlightHoverPath_(b);this.panel.tooltipGeneProfile_(b.geneName,
b.hoverConditionName,b.hoverValue)}.bind(this)).on("genotet.pathUnhover",function(a,b){this.renderer.unhighlightHoverPath_(b);genotet.tooltip.hideAll()}.bind(this)).on("genotet.pathClick",function(a,b){this.renderer.highlightLabelsForClickedProfile_(b);this.panel.displayPathInfo_(b.geneName,b.hoverConditionName,b.hoverValue)}.bind(this));$(this.loader).on("genotet.updatePanel",function(a){this.panel.dataLoaded()}.bind(this))};genotet.utils.inherit(genotet.ExpressionView,genotet.View);genotet.NetworkLoader=function(a){genotet.NetworkLoader.base.constructor.call(this,a)};genotet.utils.inherit(genotet.NetworkLoader,genotet.ViewLoader);genotet.NetworkLoader.prototype.load=function(a,b){this.loadNetwork_(a,b)};
genotet.NetworkLoader.prototype.loadNetwork_=function(a,b){this.signal("loadStart");var c={type:"network",networkName:a,geneRegex:b};$.get(genotet.data.serverURL,c,function(c){_(c).extend({networkName:a,geneRegex:b});_(this.data).extend(c);this.signal("loadComplete")}.bind(this),"jsonp").fail(this.fail.bind(this,"cannot load network",c))};
genotet.NetworkLoader.prototype.updateGenes=function(a,b){var c=this.data.geneRegex;switch(a){case "set":c=b;break;case "add":c+="|"+b;break;case "remove":this.removeGenes_(b);return}this.load(this.data.networkName,c)};
genotet.NetworkLoader.prototype.removeGenes_=function(a){var b;try{b=RegExp(a,"i")}catch(c){genotet.error("invalid gene regex",a);return}this.data.nodes=_(this.data.nodes).filter(function(a){return!a.id.match(b)});this.data.edges=_(this.data.edges).filter(function(a){return!a.source.match(b)&&!a.target.match(b)});this.updateGeneRegex_();this.signal("geneRemove")};
genotet.NetworkLoader.prototype.updateGeneRegex_=function(){var a="";this.data.nodes.forEach(function(b,c){a+=b.id+(c==this.data.nodes.length-1?"":"|")},this);this.data.geneRegex=a};genotet.NetworkLoader.prototype.incidentEdges=function(a){a={type:"incident-edges",networkName:this.data.networkName,gene:a.id};$.get(genotet.data.serverURL,a,function(a){this.data.incidentEdges=a;this.signal("incidentEdges")}.bind(this),"jsonp").fail(this.fail.bind(this,"cannot get incident edges",a))};genotet.NetworkPanel=function(a){genotet.NetworkPanel.base.constructor.call(this,a);_(this.data.options).extend({showLabels:!0,showTFToTF:!0,showTFToNonTF:!0})};genotet.utils.inherit(genotet.NetworkPanel,genotet.ViewPanel);genotet.NetworkPanel.prototype.template="dist/html/network-panel.html";genotet.NetworkPanel.prototype.SUBTIWIKI_URL="http://subtiwiki.uni-goettingen.de/bank/index.php?gene=";genotet.NetworkPanel.prototype.panel=function(a){genotet.NetworkPanel.base.panel.call(this,a)};
genotet.NetworkPanel.prototype.initPanel=function(){this.container_.find(".switches input").bootstrapSwitch({size:"mini"});[{selector:"#gene-labels",type:"label",attribute:"showLabels"},{selector:"#tf-tf",type:"visibility",attribute:"showTFToTF"},{selector:"#tf-nontf",type:"visibility",attribute:"showTFToNonTF"}].forEach(function(a){this.container_.find(a.selector).on("switchChange.bootstrapSwitch",function(b,c){this.data.options[a.attribute]=c;this.signal("update",{type:a.type})}.bind(this))},this);
["set","add","remove"].forEach(function(a){this.container_.find("#genes #"+a).click(function(){var b=this.container_.find("#genes input"),c=b.val();""==c?genotet.warning("missing input gene selection"):(b.val(""),this.signal("update",{type:"gene",regex:c,method:a}))}.bind(this))},this)};genotet.NetworkPanel.prototype.dataLoaded=function(){this.container_.find("#network input").val(this.data.networkName)};
genotet.NetworkPanel.prototype.edgeListContainer=function(){var a=this.container_.find("#edge-list");a.html(this.container_.find("#edge-list-template").html());return a.children("table")};genotet.NetworkPanel.prototype.hideNodeInfo_=function(){this.container_.find("#node-info").slideUp()};genotet.NetworkPanel.prototype.hideEdgeInfo_=function(){this.container_.find("#edge-info").slideUp()};genotet.NetworkPanel.prototype.hideInfo_=function(){this.hideNodeInfo_();this.hideEdgeInfo_()};
genotet.NetworkPanel.prototype.setNodeInfo_=function(a,b){b.html(this.container_.find("#node-info-template").html());b.children("#name").children("span").text(a.label);b.children("#is-tf").css("display",a.isTF?"":"none");b.children("#subtiwiki").children("a").attr("href",this.SUBTIWIKI_URL+a.id)};
genotet.NetworkPanel.prototype.setEdgeInfo_=function(a,b){b.html(this.container_.find("#edge-info-template").html());b.children("#source").children("span").text(a.source.label);b.children("#target").children("span").text(a.target.label);b.children("#weight").children("span").text(a.weight)};genotet.NetworkPanel.prototype.displayNodeInfo=function(a){var b=this.container_.find("#node-info").hide().slideDown();this.setNodeInfo_(a,b);b.find(".close").click(function(){this.hideNodeInfo_()}.bind(this))};
genotet.NetworkPanel.prototype.displayEdgeInfo=function(a){var b=this.container_.find("#edge-info").hide().slideDown();this.setEdgeInfo_(a,b);b.find(".close").click(function(){this.hideEdgeInfo_()}.bind(this))};genotet.NetworkPanel.prototype.tooltipNode=function(a){var b=genotet.tooltip.create();this.setNodeInfo_(a,b);b.find("#subtiwiki, .close").remove()};genotet.NetworkPanel.prototype.tooltipEdge=function(a){var b=genotet.tooltip.create();this.setEdgeInfo_(a,b);b.find(".close").remove()};genotet.NetworkRenderer=function(a,b){genotet.NetworkRenderer.base.constructor.call(this,a,b);this.filter={edgeWeight:[-Infinity,Infinity],showTFToTF:!0,showTFToNonTF:!0};this.colorScale_=d3.scale.linear();this.nodes_={};this.edges_={};this.force_=d3.layout.force();this.forceParams_={charge:-2E4,gravity:1,linkDistance:20,friction:.6};this.forcing_=!1;this.zoomTranslate_=[0,0];this.zoomScale_=1;this.mouseState_=genotet.NetworkRenderer.MouseState.NONE};
genotet.utils.inherit(genotet.NetworkRenderer,genotet.ViewRenderer);genotet.NetworkRenderer.MouseState={NONE:0,SELECT:1,ZOOM:2};genotet.NetworkRenderer.ZOOM_EXTENT=[.03125,8];genotet.NetworkRenderer.prototype.NODE_LABEL_SIZE=14;genotet.NetworkRenderer.prototype.NODE_LABEL_OFFSET_X=10;genotet.NetworkRenderer.prototype.NODE_LABEL_OFFSET_Y=genotet.NetworkRenderer.prototype.NODE_LABEL_SIZE/2;genotet.NetworkRenderer.prototype.NODE_SIZE=6;genotet.NetworkRenderer.prototype.EDGE_ARROW_LENGTH=10;
genotet.NetworkRenderer.prototype.EDGE_CURVE_SHIFT=.1;genotet.NetworkRenderer.prototype.init=function(){genotet.NetworkRenderer.base.init.call(this);this.zoom_=d3.behavior.zoom().scaleExtent(genotet.NetworkRenderer.ZOOM_EXTENT).on("zoom",this.zoomHandler_.bind(this));this.canvas.call(this.zoom_)};
genotet.NetworkRenderer.prototype.initLayout=function(){this.svgEdges_=this.canvas.append("g").classed("edges render-group",!0);this.svgNodes_=this.canvas.append("g").classed("nodes render-group",!0);this.svgNodeLabels_=this.canvas.append("g").classed("node-labels render-group",!0)};genotet.NetworkRenderer.prototype.render=function(){this.dataReady_()&&this.force_.size([this.canvasWidth_,this.canvasHeight_]).start()};genotet.NetworkRenderer.prototype.update=function(){this.drawNetwork_()};
genotet.NetworkRenderer.prototype.updateVisibility=function(){for(var a in this.edges_){var b=this.edges_[a];b.visible=!0;b.source.isTF&&(b.target.isTF&&!this.data.options.showTFToTF||!b.target.isTF&&!this.data.options.showTFToNonTF)&&(b.visible=!1)}};genotet.NetworkRenderer.prototype.dataLoaded=function(){this.prepareData_();this.render()};genotet.NetworkRenderer.prototype.resize=function(){genotet.NetworkRenderer.base.resize.call(this);this.render()};
genotet.NetworkRenderer.prototype.zoomHandler_=function(){var a=d3.event.translate,b=d3.event.scale;this.canvas.selectAll(".render-group").attr("transform",genotet.utils.getTransform(a,b));this.zoomTranslate_=a;this.zoomScale_=b;this.drawNetwork_()};genotet.NetworkRenderer.prototype.dataReady_=function(){return null!=this.data.nodes};
genotet.NetworkRenderer.prototype.prepareData_=function(){this.colorScale_=d3.scale.linear().domain([this.data.weightMin,this.data.weightMax]).range(genotet.data.redBlueScale);var a={};this.data.nodes.forEach(function(b){this.nodes_[b.id]||(this.nodes_[b.id]=_.extend({},b));a[b.id]=!0},this);this.nodes_=_(this.nodes_).pick(function(b,c){return c in a});this.edges_={};this.data.edges.forEach(function(a){this.nodes_[a.source]&&this.nodes_[a.target]?this.edges_[a.id]||(this.edges_[a.id]={id:a.id,source:this.nodes_[a.source],
target:this.nodes_[a.target],weight:a.weight[0],visible:!0}):genotet.error("edge contains nodes that do not exist",JSON.stringify(a))},this);this.force_.stop();this.force_=d3.layout.force().nodes(_.toArray(this.nodes_)).links(_.toArray(this.edges_)).charge(this.forceParams_.charge).gravity(this.forceParams_.gravity).linkDistance(this.forceParams_.linkDistance).friction(this.forceParams_.friction).on("start",function(){this.forcing=!0}.bind(this)).on("tick",this.drawNetwork_.bind(this)).on("end",function(){this.forcing=
!1}.bind(this))};genotet.NetworkRenderer.prototype.drawNetwork_=function(){this.drawNodes_();this.drawEdges_()};
genotet.NetworkRenderer.prototype.drawNodes_=function(){var a=[],b=[];$.each(this.nodes_,function(c,e){e.isTF?b.push(e):a.push(e)});var c=this.svgNodes_.selectAll("circle").data(a,function(a){return a.id});c.enter().append("circle").attr("r",this.NODE_SIZE).attr("id",function(a){return a.id}).on("click",function(a){this.signal("nodeClick",a);this.selectNode(a)}.bind(this)).on("mouseenter",function(a){this.signal("nodeHover",a)}.bind(this)).on("mouseleave",function(a){this.signal("nodeUnhover",a)}.bind(this));
c.exit().remove();c.attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y});c=this.svgNodes_.selectAll("rect").data(b,function(a){return a.id});c.enter().append("rect").attr("id",function(a){return a.id}).attr("width",2*this.NODE_SIZE).attr("height",2*this.NODE_SIZE).on("click",function(a){this.signal("nodeClick",a);this.selectNode(a)}.bind(this)).on("mouseenter",function(a){this.signal("nodeHover",a)}.bind(this)).on("mouseleave",function(a){this.signal("nodeUnhover",a)}.bind(this));
c.exit().remove();c.attr("x",function(a){return a.x-this.NODE_SIZE}.bind(this)).attr("y",function(a){return a.y-this.NODE_SIZE}.bind(this));this.drawNodeLabels_()};
genotet.NetworkRenderer.prototype.drawNodeLabels_=function(){if(this.data.options.showLabels){var a=this.svgNodeLabels_.selectAll("text").data(_.toArray(this.nodes_),function(a){return a.id});a.enter().append("text").text(function(a){return a.label});a.exit().remove();var b=this.NODE_LABEL_OFFSET_Y/this.zoomScale_;a.style("font-size",this.NODE_LABEL_SIZE/this.zoomScale_).attr("x",function(a){return a.x+this.NODE_LABEL_OFFSET_X}.bind(this)).attr("y",function(a){return a.y+b}.bind(this))}else this.svgNodeLabels_.selectAll("*").remove()};
genotet.NetworkRenderer.prototype.drawEdges_=function(){var a=function(a){return this.colorScale_(a.weight)}.bind(this),b=function(a,b){var c=genotet.utils.middlePoint(a,b),d=genotet.utils.subtractVector(a,b),d=genotet.utils.perpendicularVector(d),d=genotet.utils.normalizeVector(d),d=genotet.utils.multiplyVector(d,genotet.utils.vectorDistance(a,b)*this.EDGE_CURVE_SHIFT);return genotet.utils.addVector(c,d)}.bind(this),c=this.svgEdges_.selectAll("g").data(_.toArray(this.edges_),function(a){return a.id}),
a=c.enter().append("g").style("stroke",a).style("fill",a).on("click",function(a){this.signal("edgeClick",a);this.selectEdge(a)}.bind(this)).on("mouseenter",function(a){this.signal("edgeHover",a)}.bind(this)).on("mouseleave",function(a){this.signal("edgeUnhover",a)}.bind(this));a.append("path").classed("edge",!0);a.append("path").classed("arrow",!0);c.exit().remove();c.style("display",function(a){return a.visible?"":"none"});var d=d3.svg.line().interpolate("basis");this.svgEdges_.selectAll("path.edge").data(_.toArray(this.edges_),
function(a){return a.id}).attr("d",function(a){var c=[a.source.x,a.source.y];a=[a.target.x,a.target.y];var e=b(c,a);return d([c,e,a])});var e=function(a,c){var d=b(a,c),e=genotet.utils.normalizeVector(genotet.utils.subtractVector(a,c)),f=genotet.utils.normalizeVector(genotet.utils.subtractVector(d,c)),f=genotet.utils.addVector(c,genotet.utils.multiplyVector(f,this.NODE_SIZE)),e=genotet.utils.addVector(f,genotet.utils.multiplyVector(e,this.EDGE_ARROW_LENGTH)),d=genotet.utils.mirrorPoint(e,f,d,1);return[f,
e,d]}.bind(this),f=d3.svg.line().interpolate("linear-closed");this.svgEdges_.selectAll("path.arrow").data(_.toArray(this.edges_),function(a){return a.id}).attr("d",function(a){a=e([a.source.x,a.source.y],[a.target.x,a.target.y]);return f(a)})};genotet.NetworkRenderer.prototype.selectNode=function(a){this.data.nodeSelected=a;var b=a.id;this.svgNodes_.selectAll("rect, circle").classed("active",function(a){return a.id==b}.bind(this))};
genotet.NetworkRenderer.prototype.selectEdge=function(a){this.data.edgeSelected=a;var b=a.id;this.svgEdges_.selectAll("g").classed("active",function(a){return a.id==b}.bind(this))};genotet.NetworkTable=function(a){this.data=a};
genotet.NetworkTable.prototype.create=function(a,b){var c={};this.data.edges.forEach(function(a){c[a.id]=!0});b.forEach(function(a){a.added=a.id in c});a.DataTable({data:b,columnDefs:[{render:function(a){return a?"&#10004;":""},targets:3}],columns:[{title:"Source",data:"source"},{title:"Target",data:"target"},{title:"Weight",data:"weight"},{title:"",data:"added"}],lengthMenu:[5,10,20,50],pageLength:5,pagingType:"full"});a.closest("#edge-list").css("width",a.width())};genotet.NetworkView=function(a,b){genotet.NetworkView.base.constructor.call(this,a);this.container.addClass("network");this.loader=new genotet.NetworkLoader(this.data);this.panel=new genotet.NetworkPanel(this.data);this.table=new genotet.NetworkTable(this.data);this.renderer=new genotet.NetworkRenderer(this.container,this.data);$(this.container).on("genotet.ready",function(){this.loader.load(b.networkName,b.geneRegex)}.bind(this));$(this.panel).on("genotet.update",function(a,b){switch(b.type){case "label":this.renderer.update();
break;case "visibility":this.renderer.updateVisibility();this.renderer.update();break;case "gene":this.loader.updateGenes(b.method,b.regex);break;default:genotet.error("unknown update type",b.type)}}.bind(this));$(this.loader).on("genotet.geneRemove",function(){this.renderer.dataLoaded()}.bind(this)).on("genotet.incidentEdges",function(){this.table.create(this.panel.edgeListContainer(),this.data.incidentEdges)}.bind(this));$(this.renderer).on("genotet.nodeClick",function(a,b){this.panel.displayNodeInfo(b);
this.loader.incidentEdges(b)}.bind(this)).on("genotet.nodeHover",function(a,b){this.panel.tooltipNode(b)}.bind(this)).on("genotet.nodeUnhover",function(a,b){genotet.tooltip.hideAll()}.bind(this)).on("genotet.edgeClick",function(a,b){this.panel.displayEdgeInfo(b)}.bind(this)).on("genotet.edgeHover",function(a,b){this.panel.tooltipEdge(b)}.bind(this)).on("genotet.edgeUnhover",function(a,b){genotet.tooltip.hideAll()}.bind(this))};genotet.utils.inherit(genotet.NetworkView,genotet.View);genotet.data={};genotet.data.bindingGenes=[];genotet.data.bindingChrs=[];genotet.data.organism="th17";genotet.data.redBlueScale=["#ab1e1e","gray","#1e6eab"];genotet.data.redYellowScale=["black","red","yellow"];
genotet.data.init=function(){genotet.data.serverURL="file:"==window.location.protocol?"http://localhost:3000/genotet":window.location.protocol+"//"+window.location.hostname+":3000/genotet";genotet.data.uploadURL=genotet.data.serverURL+"/upload";for(var a=0;19>a;a++)genotet.data.bindingChrs.push((a+1).toString());genotet.data.bindingChrs=genotet.data.bindingChrs.concat(["M","X","Y"])};genotet.dialog={};genotet.dialog.TEMPLATES_={organism:"dist/html/organism.html",view:"dist/html/create-view.html",network:"templates/create-network.html",binding:"templates/create-binding.html",expression:"templates/create-expression.html",upload:"templates/upload.html"};
genotet.dialog.create=function(a){if(null==a)console.error("undefined dialog type in create");else switch(a){case "create-view":genotet.dialog.createView_();break;case "create-network":genotet.dialog.createNetwork_();break;case "create-binding":genotet.dialog.createBinding_();break;case "create-expression":genotet.dialog.createExpression_();break;case "organism":genotet.dialog.organism_();break;case "upload":genotet.dialog.upload_();break;default:genotet.error("unknown view type in Dialog.create:",
a)}};genotet.dialog.organism_=function(){var a=$("#modal");a.find(".modal-content").load(genotet.dialog.TEMPLATES_.organism,function(){a.modal();a.find(".btn-organism").removeClass("active").click(function(){genotet.data.organism=$(this).attr("id");a.find(".btn-organism").removeClass("active");$(this).addClass("active")});a.find("#"+genotet.data.organism).addClass("active")})};
genotet.dialog.createView_=function(){var a=$("#modal");a.find(".modal-content").load(genotet.dialog.TEMPLATES_.view,function(){a.modal();a.find(".selectpicker").selectpicker();a.find("#btn-next").click(function(){var b=a.find("#type").val();switch(b){case "network":genotet.dialog.create("create-network");break;case "binding":genotet.dialog.create("create-binding");break;case "expression":genotet.dialog.create("create-expression");break;default:genotet.error("unknown view type in Dialog.createView:",
b)}})})};
genotet.dialog.createNetwork_=function(){var a=$("#modal");a.find(".modal-content").load(genotet.dialog.TEMPLATES_.network,function(){a.modal();var b=a.find("#view-name");b.val(genotet.viewManager.nextSuffixName(b.val()));a.find(".selectpicker").selectpicker();$.get(genotet.data.serverURL,{type:"list-network"},function(b){b.forEach(function(b){a.find(".selectpicker").append("<option>"+b.networkName+"</option>")});a.find(".selectpicker").selectpicker("refresh")}.bind(this),"jsonp").fail(function(){genotet.error("failed to get network list")});a.find("#btn-create").click(function(){var b=
a.find("#view-name").val();genotet.viewManager.createView("network",b,{networkName:a.find("#network").val(),geneRegex:a.find("#geneRegex").val()})})})};
genotet.dialog.createBinding_=function(){var a=$("#modal");a.find(".modal-content").load(genotet.dialog.TEMPLATES_.binding,function(){a.modal();var b=a.find("#view-name");b.val(genotet.viewManager.nextSuffixName(b.val()));b=genotet.data.bindingChrs.map(function(a,b){return{id:a,text:a}});a.find("#chr").select2({data:b});var c=[];$.get(genotet.data.serverURL,{type:"list-binding"},function(b){b.forEach(function(a){c.push({id:a.bindingName,text:a.bindingName})});a.find("#gene").select2({data:c})}.bind(this),
"jsonp").fail(function(){genotet.error("failed to get binding list")});a.find("#btn-create").click(function(){var b=a.find("#view-name").val();genotet.viewManager.createView("binding",b,{gene:a.find("#gene").val(),chr:a.find("#chr").val()})})})};
genotet.dialog.createExpression_=function(){var a=$("#modal");a.find(".modal-content").load(genotet.dialog.TEMPLATES_.expression,function(){a.modal();var b=a.find("#view-name");b.val(genotet.viewManager.nextSuffixName(b.val()));a.find(".selectpicker").selectpicker();$.get(genotet.data.serverURL,{type:"list-matrix"},function(b){b.forEach(function(b){a.find(".selectpicker").append("<option>"+b.matrixName+"</option>")});a.find(".selectpicker").selectpicker("refresh")}.bind(this),"jsonp").fail(function(){genotet.error("failed to get expression list")});
a.find("#btn-create").click(function(){var b=a.find("#view-name").val();genotet.viewManager.createView("expression",b,{matrixName:a.find("#matrix").val(),geneRegex:a.find("#gene-regex").val(),condRegex:a.find("#cond-regex").val()})})})};
genotet.dialog.upload_=function(){var a=$("#modal");a.find(".modal-content").load(genotet.dialog.TEMPLATES_.upload,function(){a.modal();a.find(".selectpicker").selectpicker();var b=a.find("#file"),c=a.find("#data-name"),d=a.find("#btn-upload").prop("disabled",!0),e=a.find("#btn-file"),f=a.find("#file-display");e.click(function(){b.trigger("click")});f.click(function(){b.trigger("click")});b.change(function(a){f.text(a.target.files[0].name);d.prop("disabled",!(c.val()&&b.val()))});c.keyup(function(){d.prop("disabled",
!(c.val()&&b.val()))});d.click(function(){var d=new FormData;d.append("type",a.find("#type").val());d.append("name",c.val());d.append("description",a.find("#description").val());d.append("file",b[0].files[0]);$.ajax({url:genotet.data.uploadURL,type:"POST",data:d,enctype:"multipart/form-data",processData:!1,contentType:!1}).done(function(a){a.success?genotet.success("data uploaded"):genotet.error("failed to upload data",a.message)}).fail(function(a){genotet.error("failed to upload data")})})})};genotet.menu={};
genotet.menu.init=function(){$("#view-create").click(function(){genotet.dialog.create("create-view")});$("#view-closeall").click(function(){genotet.viewManager.closeAllViews()});$("#preset-default").click(function(){genotet.preset.loadPreset("default")});$("#preset-network").click(function(){genotet.preset.loadPreset("network")});$("#preset-expression").click(function(){genotet.preset.loadPreset("expression")});$("#preset-binding").click(function(){genotet.preset.loadPreset("binding")});$("#option-alert").click(function(){genotet.options.toggleAllowAlert()});
$("#doc").click(function(){window.open("doc.html")});$("#organism").click(function(){genotet.dialog.create("organism")});$("#upload").click(function(){genotet.dialog.create("upload")})};genotet.options={};genotet.options.allowMessage=!0;genotet.options.init=function(){};genotet.options.toggleAllowMessage=function(){genotet.options.allowMessage=!genotet.options.allowMessage};genotet.panelManager={};genotet.panelManager.COLLAPSED_WIDTH=32;genotet.panelManager.TRANSITION_TIME=300;genotet.panelManager.showPanel_=!0;genotet.panelManager.container_=null;genotet.panelManager.init=function(){genotet.panelManager.showPanel_=!0;genotet.panelManager.container_=$("#side-panel");genotet.panelManager.container_.children("#btn-toggle").click(function(){genotet.panelManager.togglePanel_()});$(".sideways").click(function(){genotet.panelManager.showPanel_||genotet.panelManager.togglePanel_()})};
genotet.panelManager.getWidth_=function(){return genotet.panelManager.container_.find(".tab-content").outerWidth()+genotet.panelManager.COLLAPSED_WIDTH};
genotet.panelManager.togglePanel_=function(){genotet.panelManager.container_.toggleClass("active");genotet.panelManager.showPanel_=!genotet.panelManager.showPanel_;var a=genotet.panelManager.showPanel_?0:-(genotet.panelManager.getWidth_()-genotet.panelManager.COLLAPSED_WIDTH);genotet.panelManager.container_.animate({right:a+"px"},{duration:genotet.panelManager.TRANSITION_TIME,complete:function(){$("#icon-button").toggleClass("glyphicon-chevron-right glyphicon-chevron-left")}})};
genotet.panelManager.activatePanel_=function(a){var b="panel-tab-"+a;a="panel-view-"+a;$(".sideways li.active").removeClass("active");$("#"+b).addClass("active");$(".tab-content div.active").removeClass("active");$("#"+a).addClass("active")};
genotet.panelManager.addPanel=function(a){var b=a.viewID_,c="panel-tab-"+b,d="panel-view-"+b;$("#panel-tab-init").clone().attr("id",c).appendTo(".sideways").find("a").attr("href","#"+d).append(a.name());$("#panel-view-init").clone().attr("id",d).appendTo(".tab-content");$(a).on("genotet.focus",function(){genotet.panelManager.activatePanel_(a.viewID_)});$(".sideways li a").off().click(function(a){a.stopPropagation();genotet.panelManager.showPanel_||genotet.panelManager.togglePanel_();a=$(a.target).parent().attr("id").replace("panel-tab-",
"");var b=a.replace(/\-/g," "),b=genotet.viewManager.views[b];genotet.viewManager.blurAllViews();b.focus(!1);genotet.panelManager.activatePanel_(a)});genotet.panelManager.container_.show();genotet.panelManager.showPanel_||genotet.panelManager.togglePanel_();genotet.panelManager.activatePanel_(b);genotet.viewManager.blurAllViews();a.focus(!1);return $("#panel-view-"+b)};
genotet.panelManager.removePanel=function(a){var b=a.replace(/\s/g,"-");a=$("#panel-tab-"+b);var b=$("#panel-view-"+b),c=a.hasClass("active");a.remove();b.remove();c&&$(".sideways li").last().find("a").tab("show");1==$(".sideways").children().length&&genotet.panelManager.container_.hide()};
genotet.panelManager.closeAllPanels=function(){var a=$(".sideways");a.empty();$('<li><a href="#view-init" data-toggle="tab"></a></li>').attr("id","panel-tab-init").appendTo(a);a=$(".tab-content");a.empty();$("<div></div>").addClass("tab-pane active").attr("id","panel-view-init").appendTo(a);$("#side-panel").css("display","none")};genotet.preset={};genotet.preset.loadPreset=function(a){a||(a="default");switch(a){case "default":break;case "network":break;case "expression":break;case "binding":break;default:genotet.error("unknown preset:",a)}};genotet.tooltip={};genotet.tooltip.container_=null;genotet.tooltip.mouseX_=0;genotet.tooltip.mouseY_=0;genotet.tooltip.DEFAULT_OFFSET_=5;genotet.tooltip.init=function(){genotet.tooltip.container_=$("#tooltip").hide();$(window).mousemove(function(a){genotet.tooltip.mouseX_=a.pageX;genotet.tooltip.mouseY_=a.pageY})};
genotet.tooltip.create=function(a,b){var c=null==a?genotet.tooltip.mouseX_:a,d=null==b?genotet.tooltip.mouseY_:b,c=c+genotet.tooltip.DEFAULT_OFFSET_,d=d+genotet.tooltip.DEFAULT_OFFSET_;genotet.tooltip.hideAll();genotet.tooltip.container_.css({left:c,top:d});return genotet.tooltip.container_.show()};genotet.tooltip.hideAll=function(){genotet.tooltip.container_.children("*").remove();genotet.tooltip.container_.hide()};genotet.viewManager={};genotet.viewManager.views={};genotet.viewManager.init=function(){genotet.viewManager.views={};var a=function(){$("#main").css({width:$(window).width()-genotet.panelManager.COLLAPSED_WIDTH,height:$(window).height()-$(".navbar-fixed-top").outerHeight()})};$(window).resize(a);a();$(".alert button").click(function(){$(this).parent().slideUp()});$("html").click(function(){genotet.viewManager.blurAllViews()})};
genotet.viewManager.createView=function(a,b,c){if(b)if(b in genotet.viewManager.views)genotet.error("duplicate view name");else{c||(c={});switch(a){case "network":a=new genotet.NetworkView(b,c);break;case "expression":a=new genotet.ExpressionView(b,c);break;case "binding":a=new genotet.BindingView(b,c);break;default:genotet.error("unknown view type");return}genotet.viewManager.views[b]=a;b=genotet.panelManager.addPanel(a);a.createPanel(b)}else genotet.error("empty view name")};
genotet.viewManager.closeView=function(a){a.name()in genotet.viewManager.views?(delete genotet.viewManager.views[a.name()],genotet.panelManager.removePanel(a.name())):genotet.error("view does not exist, cannot delete")};genotet.viewManager.blurAllViews=function(){$.each(genotet.viewManager.views,function(a,b){b.blur()})};genotet.viewManager.closeAllViews=function(){$.each(genotet.viewManager.views,function(a,b){b.close()});genotet.viewManager.views={};genotet.panelManager.closeAllPanels()};
genotet.viewManager.findPosition=function(a){var b=a.rect(),c=!1,d=[],e;for(e in genotet.viewManager.views){var f=genotet.viewManager.views[e];f!=a&&(c=!0,f=f.rect(),d.push($.extend({},b,{x:f.x+f.w,y:f.y})),d.push($.extend({},b,{x:f.x,y:f.y+f.h})))}d.sort(function(a,b){return genotet.utils.sign(a.y-b.y)||genotet.utils.sign(a.x-b.x)});for(e=0;e<d.length;e++)if(f=d[e],genotet.utils.rectInsideWindow(f)){var g=!0,h;for(h in genotet.viewManager.views){var k=genotet.viewManager.views[h];if(k!=a&&genotet.utils.rectIntersect(k.rect(),
f)){g=!1;break}}if(g)return{left:f.x,top:f.y}}return c?{left:$(window).width()/2-b.w/2,top:$(window).height()/2-b.h/2}:{left:0,top:0}};genotet.viewManager.nextSuffixName=function(a){for(var b=1;;b++){var c=1==b?a:a+" "+b;if(!(c in genotet.viewManager.views))return c}};
